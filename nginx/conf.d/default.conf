# Image cache zone for external images
proxy_cache_path /var/cache/nginx/images levels=1:2 keys_zone=images:50m max_size=2g inactive=60d use_temp_path=off;

upstream fastapi {
    server backend:8000;
}

server {
    listen 80;
    server_name _;

    client_max_body_size 20M;

    # API endpoints -> FastAPI backend
    location /api/ {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Direct backend access (for development)
    location / {
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /health {
        access_log off;
        proxy_pass http://fastapi/health;
    }

    # Local static images
    # Fighter photos, event posters stored locally
    location /images/ {
        alias /var/www/images/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri @placeholder;
    }

    # Proxy and cache images from Tapology
    # Usage: /proxy/tapology/path/to/image.jpg
    location /proxy/tapology/ {
        # Bloquear métodos que no sean GET/HEAD
        if ($request_method !~ ^(GET|HEAD)$) {
            return 405;
        }

        proxy_pass https://images.tapology.com/;
        proxy_ssl_server_name on;
        
        # Headers fijos (no heredar del cliente)
        proxy_set_header Host images.tapology.com;
        proxy_set_header Accept image/webp,image/jpeg,image/png;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        proxy_set_header Referer "https://www.tapology.com/";
        
        # Cache key explícita (determinista)
        proxy_cache_key "$scheme$proxy_host$request_uri";
        proxy_cache images;
        proxy_cache_valid 200 14d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_background_update on;
        proxy_cache_methods GET HEAD;
        
        # Límite de tamaño
        proxy_max_temp_file_size 50m;
        
        # Headers de respuesta
        add_header X-Cache-Status $upstream_cache_status;
        expires 14d;
        add_header Cache-Control "public, immutable";
        
        # Handle errors
        proxy_intercept_errors on;
        error_page 404 = @placeholder;
    }

    # Proxy and cache images from UFC CDN
    # Usage: /proxy/ufc/path/to/image.jpg
    location /proxy/ufc/ {
        if ($request_method !~ ^(GET|HEAD)$) {
            return 405;
        }

        proxy_pass https://dmxg5wxfqgb4u.cloudfront.net/;
        proxy_ssl_server_name on;
        
        proxy_set_header Host dmxg5wxfqgb4u.cloudfront.net;
        proxy_set_header Accept image/webp,image/jpeg,image/png;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        proxy_set_header Referer "https://www.ufc.com/";
        
        proxy_cache_key "$scheme$proxy_host$request_uri";
        proxy_cache images;
        proxy_cache_valid 200 60d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_methods GET HEAD;
        
        proxy_max_temp_file_size 50m;
        
        add_header X-Cache-Status $upstream_cache_status;
        expires 60d;
        add_header Cache-Control "public, immutable";

        proxy_intercept_errors on;
        error_page 404 = @placeholder;
    }

    # Placeholder for missing images
    location @placeholder {
        default_type image/svg+xml;
        return 200 '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect fill="#1a1a2e" width="200" height="200"/><text x="100" y="100" text-anchor="middle" fill="#666" font-family="Arial" font-size="14">No Image</text></svg>';
    }
}
